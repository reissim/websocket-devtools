<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebSocket åŠ«æŒéªŒè¯</title>
    <style>
      body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          background: #1a1a1a;
          color: #e0e0e0;
          padding: 20px;
          max-width: 800px;
          margin: 0 auto;
      }
      .container {
          background: #2a2a2a;
          padding: 20px;
          border-radius: 8px;
          margin: 20px 0;
      }
      button {
          background: #007acc;
          color: white;
          border: none;
          padding: 10px 20px;
          border-radius: 4px;
          cursor: pointer;
          margin: 10px 5px;
      }
      button:hover {
          background: #005a9e;
      }
      .log {
          background: #333;
          color: #0f0;
          padding: 15px;
          border-radius: 4px;
          font-family: 'Courier New', monospace;
          font-size: 14px;
          max-height: 400px;
          overflow-y: auto;
          white-space: pre-wrap;
          margin: 10px 0;
      }
      .test-result {
          padding: 10px;
          border-radius: 4px;
          margin: 10px 0;
      }
      .success {
          background: #2d5016;
          border: 1px solid #4caf50;
      }
      .error {
          background: #5d2b2b;
          border: 1px solid #f44336;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ” WebSocket åŠ«æŒéªŒè¯å·¥å…·</h1>

    <div class="container">
      <h2>ğŸ§ª åŸºç¡€æ£€æŸ¥</h2>
      <button onclick="checkWebSocket()">æ£€æŸ¥ WebSocket</button>
      <button onclick="testWebSocketCreation()">æµ‹è¯• WebSocket åˆ›å»º</button>
      <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>

      <div id="testResults"></div>
      <div class="log" id="log"></div>
    </div>

    <div class="container">
      <h2>ğŸŒ WebSocket è¿æ¥æµ‹è¯•</h2>
      <button onclick="testEchoServer()">æµ‹è¯• Echo æœåŠ¡å™¨</button>
      <button onclick="testWSS()">æµ‹è¯• WSS è¿æ¥</button>
      <div id="connectionStatus"></div>
    </div>

    <script>
      const log = document.getElementById('log');
      const testResults = document.getElementById('testResults');
      const connectionStatus = document.getElementById('connectionStatus');

      function addLog(message) {
          const timestamp = new Date().toLocaleTimeString();
          log.textContent += `[${timestamp}] ${message}\n`;
          log.scrollTop = log.scrollHeight;
      }

      function addTestResult(message, isSuccess) {
          const div = document.createElement('div');
          div.className = `test-result ${isSuccess ? 'success' : 'error'}`;
          div.textContent = message;
          testResults.appendChild(div);
      }

      function clearLog() {
          log.textContent = '';
          testResults.innerHTML = '';
          connectionStatus.innerHTML = '';
      }

      function checkWebSocket() {
          addLog('ğŸ” å¼€å§‹æ£€æŸ¥ WebSocket...');

          // æ£€æŸ¥ WebSocket æ˜¯å¦å­˜åœ¨
          if (typeof WebSocket === 'undefined') {
              addTestResult('âŒ WebSocket ä¸å­˜åœ¨', false);
              addLog('âŒ WebSocket ä¸å­˜åœ¨');
              return;
          }

          addLog('âœ… WebSocket å­˜åœ¨');

          // æ£€æŸ¥æ˜¯å¦ä¸ºåŸç”Ÿ WebSocket
          const webSocketString = WebSocket.toString();
          addLog(`ğŸ” WebSocket.toString(): ${webSocketString}`);

          if (webSocketString.includes('[native code]')) {
              addTestResult('âš ï¸ WebSocket æ˜¾ç¤ºä¸ºåŸç”Ÿä»£ç  - å¯èƒ½æœªè¢«åŠ«æŒ', false);
              addLog('âš ï¸ WebSocket æ˜¾ç¤ºä¸ºåŸç”Ÿä»£ç ');
          } else {
              addTestResult('âœ… WebSocket å·²è¢«åŠ«æŒ', true);
              addLog('âœ… WebSocket å·²è¢«åŠ«æŒ');
          }

          // æ£€æŸ¥ WebSocket æ„é€ å‡½æ•°å±æ€§
          addLog(`ğŸ” WebSocket.name: ${WebSocket.name}`);
          addLog(`ğŸ” WebSocket.length: ${WebSocket.length}`);

          // æ£€æŸ¥å¸¸é‡
          const constants = ['CONNECTING', 'OPEN', 'CLOSING', 'CLOSED'];
          constants.forEach(constant => {
              if (WebSocket[constant] !== undefined) {
                  addLog(`âœ… WebSocket.${constant} = ${WebSocket[constant]}`);
              } else {
                  addLog(`âŒ WebSocket.${constant} æœªå®šä¹‰`);
              }
          });
      }

      function testWebSocketCreation() {
          addLog('ğŸš€ æµ‹è¯• WebSocket åˆ›å»º...');

          try {
              // åˆ›å»ºä¸€ä¸ª WebSocket å®ä¾‹ï¼ˆä½¿ç”¨æ— æ•ˆ URLï¼Œä½†ä¸ä¼šç«‹å³è¿æ¥ï¼‰
              const testUrl = 'ws://localhost:9999/test';
              const ws = new WebSocket(testUrl);

              addLog('âœ… WebSocket å®ä¾‹åˆ›å»ºæˆåŠŸ');
              addLog(`ğŸ” WebSocket å®ä¾‹ç±»å‹: ${typeof ws}`);
              addLog(`ğŸ” WebSocket å®ä¾‹æ„é€ å‡½æ•°: ${ws.constructor.name}`);
              addLog(`ğŸ” WebSocket URL: ${ws.url}`);
              addLog(`ğŸ” WebSocket readyState: ${ws.readyState}`);

              // æ£€æŸ¥æ–¹æ³•æ˜¯å¦å­˜åœ¨
              const methods = ['send', 'close', 'addEventListener', 'removeEventListener'];
              methods.forEach(method => {
                  if (typeof ws[method] === 'function') {
                      addLog(`âœ… ws.${method} æ–¹æ³•å­˜åœ¨`);
                  } else {
                      addLog(`âŒ ws.${method} æ–¹æ³•ä¸å­˜åœ¨`);
                  }
              });

              // æ£€æŸ¥æ˜¯å¦æœ‰ä»£ç†æ ‡è®°
              if (ws._isProxied) {
                  addTestResult('âœ… WebSocket å·²è¢«ä»£ç†', true);
                  addLog('âœ… å‘ç°ä»£ç†æ ‡è®°');
              } else {
                  addLog('âš ï¸ æœªå‘ç°ä»£ç†æ ‡è®°');
              }

              // ç«‹å³å…³é—­è¿æ¥
              ws.close();

          } catch (error) {
              addTestResult(`âŒ WebSocket åˆ›å»ºå¤±è´¥: ${error.message}`, false);
              addLog(`âŒ WebSocket åˆ›å»ºå¤±è´¥: ${error.message}`);
          }
      }

      function testEchoServer() {
          addLog('ğŸŒ æµ‹è¯• Echo æœåŠ¡å™¨è¿æ¥...');
          connectionStatus.innerHTML = '<div style="color: orange;">ğŸ”„ æ­£åœ¨è¿æ¥...</div>';

          try {
              // ä½¿ç”¨å…¬å…±çš„ WebSocket Echo æœåŠ¡å™¨
              const ws = new WebSocket('wss://echo.websocket.org/');

              ws.onopen = function(event) {
                  addLog('âœ… Echo æœåŠ¡å™¨è¿æ¥æˆåŠŸ');
                  connectionStatus.innerHTML = '<div style="color: green;">âœ… è¿æ¥æˆåŠŸ</div>';

                  // å‘é€æµ‹è¯•æ¶ˆæ¯
                  const testMessage = 'Hello from WebSocket Proxy Test!';
                  ws.send(testMessage);
                  addLog(`ğŸ“¤ å‘é€æ¶ˆæ¯: ${testMessage}`);
              };

              ws.onmessage = function(event) {
                  addLog(`ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ${event.data}`);
                  connectionStatus.innerHTML = '<div style="color: green;">âœ… æ¶ˆæ¯æ”¶å‘æˆåŠŸ</div>';

                  // å…³é—­è¿æ¥
                  setTimeout(() => {
                      ws.close();
                  }, 1000);
              };

              ws.onclose = function(event) {
                  addLog(`ğŸ”’ è¿æ¥å…³é—­: code=${event.code}, reason=${event.reason}`);
                  if (event.code === 1000) {
                      addTestResult('âœ… Echo æœåŠ¡å™¨æµ‹è¯•æˆåŠŸ', true);
                  }
              };

              ws.onerror = function(error) {
                  addLog(`âŒ WebSocket é”™è¯¯: ${error}`);
                  connectionStatus.innerHTML = '<div style="color: red;">âŒ è¿æ¥å¤±è´¥</div>';
                  addTestResult('âŒ Echo æœåŠ¡å™¨è¿æ¥å¤±è´¥', false);
              };

          } catch (error) {
              addLog(`âŒ Echo æœåŠ¡å™¨æµ‹è¯•å¤±è´¥: ${error.message}`);
              connectionStatus.innerHTML = '<div style="color: red;">âŒ è¿æ¥å¤±è´¥</div>';
              addTestResult(`âŒ Echo æœåŠ¡å™¨æµ‹è¯•å¤±è´¥: ${error.message}`, false);
          }
      }

      function testWSS() {
          addLog('ğŸ” æµ‹è¯• WSS å®‰å…¨è¿æ¥...');
          connectionStatus.innerHTML = '<div style="color: orange;">ğŸ”„ æ­£åœ¨è¿æ¥ WSS...</div>';

          try {
              // ä½¿ç”¨å¦ä¸€ä¸ªå…¬å…±çš„ WSS æœåŠ¡å™¨
              const ws = new WebSocket('wss://ws.postman-echo.com/raw');

              ws.onopen = function(event) {
                  addLog('âœ… WSS è¿æ¥æˆåŠŸ');
                  connectionStatus.innerHTML = '<div style="color: green;">âœ… WSS è¿æ¥æˆåŠŸ</div>';

                  // å‘é€æµ‹è¯•æ¶ˆæ¯
                  const testMessage = JSON.stringify({ type: 'test', message: 'WSS Test Message' });
                  ws.send(testMessage);
                  addLog(`ğŸ“¤ å‘é€ WSS æ¶ˆæ¯: ${testMessage}`);

                  // è‡ªåŠ¨å…³é—­
                  setTimeout(() => {
                      ws.close();
                  }, 2000);
              };

              ws.onmessage = function(event) {
                  addLog(`ğŸ“¨ æ”¶åˆ° WSS æ¶ˆæ¯: ${event.data}`);
              };

              ws.onclose = function(event) {
                  addLog(`ğŸ”’ WSS è¿æ¥å…³é—­: code=${event.code}`);
                  if (event.code === 1000) {
                      addTestResult('âœ… WSS æµ‹è¯•æˆåŠŸ', true);
                  }
              };

              ws.onerror = function(error) {
                  addLog(`âŒ WSS é”™è¯¯: ${error}`);
                  connectionStatus.innerHTML = '<div style="color: red;">âŒ WSS è¿æ¥å¤±è´¥</div>';
                  addTestResult('âŒ WSS è¿æ¥å¤±è´¥', false);
              };

          } catch (error) {
              addLog(`âŒ WSS æµ‹è¯•å¤±è´¥: ${error.message}`);
              connectionStatus.innerHTML = '<div style="color: red;">âŒ WSS è¿æ¥å¤±è´¥</div>';
              addTestResult(`âŒ WSS æµ‹è¯•å¤±è´¥: ${error.message}`, false);
          }
      }

      // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
      document.addEventListener('DOMContentLoaded', function() {
          addLog('ğŸ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹è‡ªåŠ¨æ£€æŸ¥...');
          setTimeout(checkWebSocket, 500);
      });

      // ç›‘å¬æ¥è‡ªæ‰©å±•çš„æ¶ˆæ¯
      window.addEventListener('message', function(event) {
          if (event.data && event.data.source === 'websocket-proxy-injected') {
              addLog(`ğŸ¯ æ”¶åˆ°æ‰©å±•æ¶ˆæ¯: ${JSON.stringify(event.data)}`);
              addTestResult('âœ… æ‰©å±•é€šä¿¡æ­£å¸¸', true);
          }
      });
    </script>
  </body>
</html>
